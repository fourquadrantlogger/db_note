# SQL Layer 

包含了多个子模块，下面我将逐个做一下简单的介绍：

+ 1、初始化模块

顾名思议，初始化模块就是在 MySQL Server 启动的时候，对整个系统做各种各样的初
始化操作，比如各种 buffer，cache 结构的初始化和内存空间的申请，各种系统变量的初始
化设定，各种存储引擎的初始化设置，等等。

+ 2、核心 API

核心 API 模块主要是为了提供一些需要非常高效的底层操作功能的优化实现，包括各种
底层数据结构的实现，特殊算法的实现，字符串处理，数字处理等，小文件 I/O，格式化输
出，以及最重要的内存管理部分。核心 API 模块的所有源代码都集中在 mysys 和 strings
文件夹下面，有兴趣的读者可以研究研究。

+ 3、网络交互模块

底层网络交互模块抽象出底层网络交互所使用的接口 api，实现底层网络数据的接收与
发送，以方便其他各个模块调用，以及对这一部分的维护。所有源码都在 vio 文件夹下面。

+ 4、Client & Server 交互协议模块

任何 C/S 结构的软件系统，都肯定会有自己独有的信息交互协议，MySQL 也不例外。MySQL
的 Client & Server 交互协议模块部分，实现了客户端与 MySQL 交互过程中的所有协议。
当然这些协议都是建立在现有的 OS 和网络协议之上的，如 TCP/IP 以及 Unix Socket。

+ 5、用户模块

用户模块所实现的功能，主要包括用户的登录连接权限控制和用户的授权管理。他就像
MySQL 的大门守卫一样，决定是否给来访者“开门”。

+ 6、访问控制模块

造访客人进门了就可以想干嘛就干嘛么？为了安全考虑，肯定不能如此随意。这时候就
需要访问控制模块实时监控客人的每一个动作，给不同的客人以不同的权限。访问控制模块
实现的功能就是根据用户模块中各用户的授权信息，以及数据库自身特有的各种约束，来控
制用户对数据的访问。用户模块和访问控制模块两者结合起来，组成了 MySQL 整个数据库系
统的权限安全管理的功能。

+ 7、连接管理、连接线程和线程管理

连接管理模块负责监听对 MySQL Server 的各种请求，接收连接请求，转发所有连接请
求到线程管理模块。每一个连接上 MySQL Server 的客户端请求都会被分配（或创建）一个
连接线程为其单独服务。而连接线程的主要工作就是负责 MySQL Server 与客户端的通信，
接受客户端的命令请求，传递 Server 端的结果信息等。线程管理模块则负责管理维护这些
连接线程。包括线程的创建，线程的 cache 等。

+ 8、Query 解析和转发模块

在 MySQL 中我们习惯将所有 Client 端发送给 Server 端的命令都称为 query，在 MySQL
Server 里面，连接线程接收到客户端的一个 Query 后，会直接将该 query 传递给专门负责
将各种 Query 进行分类然后转发给各个对应的处理模块，这个模块就是 query 解析和转发模
块。其主要工作就是将 query 语句进行语义和语法的分析，然后按照不同的操作类型进行分
类，然后做出针对性的转发。

+ 9、Query Cache 模块

Query Cache 模块在 MySQL 中是一个非常重要的模块，他的主要功能是将客户端提交给
MySQL 的 Select 类 query 请求的返回结果集 cache 到内存中，与该 query 的一个 hash 值做
一个对应。该 Query 所取数据的基表发生任何数据的变化之后，MySQL 会自动使该 query 的
Cache 失效。在读写比例非常高的应用系统中，Query Cache 对性能的提高是非常显著的。
当然它对内存的消耗也是非常大的。

+ 10、Query 优化器模块

Query 优化器，顾名思义，就是优化客户端请求的 query，根据客户端请求的 query 语
句，和数据库中的一些统计信息，在一系列算法的基础上进行分析，得出一个最优的策略，
告诉后面的程序如何取得这个 query 语句的结果。

+ 11、表变更管理模块

表变更管理模块主要是负责完成一些 DML 和 DDL 的 query，如：update，delte，insert，
create table，alter table 等语句的处理。

+ 12、表维护模块

表的状态检查，错误修复，以及优化和分析等工作都是表维护模块需要做的事情。

+ 13、系统状态管理模块

系统状态管理模块负责在客户端请求系统状态的时候，将各种状态数据返回给用户，像
DBA 常用的各种 show status 命令，show variables 命令等，所得到的结果都是由这个模块
返回的。

+ 14、表管理器

这个模块从名字上看来很容易和上面的表变更和表维护模块相混淆，但是其功能与变更
及维护模块却完全不同。大家知道，每一个 MySQL 的表都有一个表的定义文件，也就是*.frm
文件。表管理器的工作主要就是维护这些文件，以及一个 cache，该 cache 中的主要内容是
各个表的结构信息。此外它还维护 table 级别的锁管理。

+ 15、日志记录模块

日志记录模块主要负责整个系统级别的逻辑层的日志的记录，包括 error log，binary
log，slow query log 等。

+ 16、复制模块

复制模块又可分为 Master 模块和 Slave 模块两部分，Master 模块主要负责在
Replication 环境中读取 Master 端的 binary 日志，以及与 Slave 端的 I/O 线程交互等工作 。
Slave 模块比 Master 模块所要做的事情稍多一些，在系统中主要体现在两个线程上面。一
个是负责从 Master 请求和接受 binary 日志，并写入本地 relay log 中的 I/O 线程。另外一
个是负责从 relay log 中读取相关日志事件，然后解析成可以在 Slave 端正确执行并得到和
Master 端完全相同的结果的命令并再交给 Slave 执行的 SQL 线程。

+ 17、存储引擎接口模块

存储引擎接口模块可以说是 MySQL 数据库中最有特色的一点了。目前各种数据库产品
中，基本上只有 MySQL 可以实现其底层数据存储引擎的插件式管理。这个模块实际上只是一
个抽象类，但正是因为它成功地将各种数据处理高度抽象化，才成就了今天 MySQL 可插拔存
储引擎的特色。